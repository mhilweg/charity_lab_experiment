{% block content %}
<style>
    /* General Section Styling */
    .section-box {
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
        border: 1px solid #ddd;
    }

    /* Earnings Summary Section */
    .payment-summary {
        background-color: #f0f8ff; /* Light blue */
        border: 1px solid #d0e7ff;
    }

    /* Deduction Options Section */
    .deduction-options {
        background-color: #e9f7ef; /* Very light green */
        border: 1px solid #d8ffd0;
    }

    /* Green Button Styling */
    .btn-green {
        background-color: #28a745; /* Green */
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        font-size: 14px;
    }

    .btn-green:hover {
        background-color: #218838; /* Darker green on hover */
    }

    /* ID and Link Display Section */
    .id-link-display {
        background-color: #fff8e1; /* Light yellow */
        border: 1px solid #ffe082;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
    }

    .copy-icon {
        margin-left: 10px;
        cursor: pointer;
        color: #007bff;
        font-size: 1.2rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 12px;
        background-color: #f0f0f0;
    }

    .copy-icon:hover {
        color: #0056b3;
        background-color: #e0e0e0;
    }

    /* Password Input Styling */
    .password-container {
        text-align: center;
        margin-top: 20px;
    }

    .password-container input {
        width: 50%;
        padding: 10px;
        font-size: 1rem;
        border-radius: 5px;
        border: 1px solid #ccc;
        margin-bottom: 10px;
    }

    .password-container .error {
        color: red;
        font-size: 0.9rem;
    }
</style>

<div class="container mt-5">
    <h2 class="text-center">Payment Information and Deduction</h2>
    <hr>

    <form method="post" id="payment-deduction-form">

        <!-- Earnings Summary Section -->
        <div class="section-box payment-summary">
            <p>You earned (after donation): <strong>â‚¬{{ net_earnings_after_donation }}</strong>.</p>
            <p>You donated: <strong>â‚¬{{ formatted_donated_amount }}</strong>.</p>
            <p>If you choose to deduct your donation, you will be reimbursed: <strong>â‚¬{{ reimbursement_amount }}</strong>.</p>
        </div>

        <!-- Tax Deduction Section -->
        <div class="section-box deduction-options">
            <p>Would you like to deduct your donation for tax reimbursement?</p>
            <div class="form-check form-check-inline">
                <input 
                    class="form-check-input" 
                    type="radio" 
                    name="deduct_donation" 
                    id="deduct_yes" 
                    value="1" 
                    {% if donated_amount == 0 %}disabled{% endif %}>
                <label class="form-check-label" for="deduct_yes">Yes</label>
            </div>
            <div class="form-check form-check-inline">
                <input 
                    class="form-check-input" 
                    type="radio" 
                    name="deduct_donation" 
                    id="deduct_no" 
                    value="0">
                <label class="form-check-label" for="deduct_no">No</label>
            </div>
            <div id="deduction-error" class="error-message">Please make a deduction decision.</div>
        </div>

        <!-- Merged Session and Participant IDs with Link Section -->
        <div class="section-box id-link-display">
            <h4><strong>Payment identifiers</strong></h4>
            <p>Session ID: <span id="session-id">{{ session_code }}</span>
                <i class="copy-icon" onclick="copyToClipboard('session-id')">ðŸ“„</i>
            </p>
            <p>Participant ID: <span id="participant-id">{{ participant_code }}</span>
                <i class="copy-icon" onclick="copyToClipboard('participant-id')">ðŸ“„</i>
            </p>

            <p>Please click the button below to access the external payment survey or payment tool. There, you need to enter all payment-relevant details, including your IDs. Once you submit the survey, you can safely close the tab.</p>

            {% if university == 'uni_wien' %}
                <a href="https://vcee.univie.ac.at/online-experiments/getting-your-payment/" target="_blank" class="btn btn-green">
                    Proceed to Payment Tool
                </a>
            {% elif university == 'wu_wien' %}
                <a href="https://wu-payment-survey-239a632bf340.herokuapp.com/?session_id={{ session_code }}&participant_id={{ participant_code }}" target="_blank" class="btn btn-green">
                    Proceed to Payment Survey
                </a>
            {% endif %}
        </div>

        <!-- Password Input Section -->
        <div class="password-container">
            <input type="text" id="password-input" name="entered_password" placeholder="Enter the password" required>
            <div id="error-message" class="error" style="display: none;">Please remain seated until you are asked to go back to your assigned seat.</div>
        </div>

        <!-- Buttons -->
        <div class="text-center mt-3">
            <button type="submit" class="btn btn-green" id="conclude-button" disabled>Continue Experiment</button>
        </div>
    </form>
</div>

<script>
    function copyToClipboard(elementId) {
        const text = document.getElementById(elementId).textContent;
        navigator.clipboard.writeText(text).then(() => {
            alert('Copied to clipboard!');
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        const passwordInput = document.getElementById("password-input");
        const concludeButton = document.getElementById("conclude-button");
        const errorMessage = document.getElementById("error-message");

        const validPasswords = ["Victoria!", "Michael!"];

        passwordInput.addEventListener("input", () => {
            const enteredPassword = passwordInput.value.trim();

            if (validPasswords.includes(enteredPassword)) {
                concludeButton.disabled = false; // Enable the button
                errorMessage.style.display = "none"; // Hide error message
            } else {
                concludeButton.disabled = true; // Disable the button
                errorMessage.style.display = "block"; // Show error message
            }
        });
    });

    // Validate deduction decision
    document.getElementById('payment-deduction-form').addEventListener('submit', function (event) {
        const deductYes = document.getElementById('deduct_yes');
        const deductNo = document.getElementById('deduct_no');
        const deductionError = document.getElementById('deduction-error');

        if (!deductYes.checked && !deductNo.checked) {
            deductionError.style.display = 'block';
            event.preventDefault();
        } else {
            deductionError.style.display = 'none';
        }
    });
</script>
{% endblock %}
